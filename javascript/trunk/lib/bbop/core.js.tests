////
//// Some unit testing for core.js
////
//// Usage:
////    Command line: "js -f core.tests.js"
////    Interactive: "js -f core.tests.js -f -"
////


// Load testing.
load('test.js');
var mr_t = new bbop.test();

// Correct environment.
load('core.js');

///
/// Start unit testing.
///

// Cloning.
var o1 = {'foo': 1, 'bar': 2};
var o2 = bbop.core.clone(o1);
mr_t.is_same_hash(o1, o2);

// Namespace generation.
bbop.core.namespace("happy", "bar");
mr_t.is_defined(happy.bar, "made namespace");
happy.bar.prop = true;
mr_t.is_same_atom(true, happy.bar.prop, "added prop to new NS");

// each: array iterator.
(function(){
    var sum_val = 0;
    var sum_i = 0;
    var sum_array = [1, 2, 3];
    function sum_add(in_num, in_index){
	sum_val = sum_val + in_num;
	sum_i = in_index;
    }
    bbop.core.each(sum_array, sum_add);
    mr_t.is_same_atom(6, sum_val, "iterated value");
    mr_t.is_same_atom(2, sum_i, "iterated index");
})();

// each: hash iterator.
(function(){
    var sum_val = 0;
    var sum_s = '';
    var sum_hash = {'dog': 2, 'cat': 4, 'cow': 6};
    function sum_add(in_key, in_val){
	sum_val = sum_val + in_val;
	sum_s = sum_s + in_key;
    }
    bbop.core.each(sum_hash, sum_add);
    mr_t.is_same_atom(9, sum_s.length, "iterated key");
    mr_t.is_same_atom(12, sum_val, "iterated value");
})();

// pare: for arrays.
(function(){

     var ir1 = [1, 2, 3, 4, 5];

     var or1 = bbop.core.pare(ir1, null, null);
     mr_t.is_same_atom(5, or1.length, "ir1 test 1");
     mr_t.is_same_atom(1, or1[0], "ir1 test 2");
     mr_t.is_same_atom(5, or1[4], "ir1 test 3");
     
     var or2 = bbop.core.pare(ir1,
			      function(item, i){ // remove even index items
				  if( i % 2 == 0 ){
				      return true;
				  }else{
				      return false;
				  }
			      }, null);
     mr_t.is_same_atom(2, or2.length, "ir1 test 4");
     mr_t.is_same_atom(2, or2[0], "ir1 test 5");
     mr_t.is_same_atom(4, or2[1], "ir1 test 6");
     
     var or3 = bbop.core.pare(ir1,
			      function(item, i){ // remove even items
				  if( item % 2 == 0 ){
				      return true;
				  }else{
				      return false;
				  }
			      },
			      function(a, b){ // reverse order
				  if( a > b ){
				      return -1;
				  }else if( b > a ){
				      return 1;
				  }else{
				      return 0;
				  }
			      });
     mr_t.is_same_atom(3, or3.length, "ir1 test 7");
     mr_t.is_same_atom(5, or3[0], "ir1 test 8");
     mr_t.is_same_atom(1, or3[2], "ir1 test 9");
     
     var ir2 = [{a: 1, b: 2},
		{a: 3, b: 4},
		{a: 5, b: 6},
		{a: 7, b: 8},
		{a: 9, b: 10}];

     var or4 = bbop.core.pare(ir2,
			      function(item, i){ // remove a's % 3
				  if( item['a'] % 3 == 0 ){
				      return true;
				  }else{
				      return false;
				  }
			      },
			      function(a, b){ // reverse order
				  if( a['b'] > b['b'] ){
				      return -1;
				  }else if( b['b'] > a['b'] ){
				      return 1;
				  }else{
				      return 0;
				  }
			      });
     mr_t.is_same_atom(3, or4.length, "ir2 test 1");
     mr_t.is_same_atom(8, or4[0]['b'], "ir2 test 2");
     mr_t.is_same_atom(2, or4[2]['b'], "ir2 test 3");
     
})();

// pare: for hashes.
// (function(){

     var ir1 = {
	 u: {a: 1, b: 2},
	 v: {a: 3, b: 4},
	 x: {a: 5, b: 6},
	 y: {a: 7, b: 8},
	 z: {a: 9, b: 10}
     };

     var or1 = bbop.core.pare(ir1, null, null);
     mr_t.is_same_atom(5, or1.length, "hash ir1 test 1");
     mr_t.is_same_atom(1, or1[0]['a'], "hash ir1 test 2");
     mr_t.is_same_atom(10, or1[4]['b'], "hash ir1 test 3");
     
     var or2 = bbop.core.pare(ir1,
			      function(key, val){ // remove b's smaller than 5
				  if( val['b'] < 5 ){
				      return true;
				  }else{
				      return false;
				  }
			      }, null);
     mr_t.is_same_atom(3, or2.length, "hash ir1 test 4");
     mr_t.is_same_atom(5, or2[0]['a'], "hash ir1 test 5");
     mr_t.is_same_atom(10, or2[2]['b'], "hash ir1 test 6");
     
     var or3 = bbop.core.pare(ir1,
			      function(key, val){ // remove 'x' item
				  if( key == 'x' ){
				      return true;
				  }else{
				      return false;
				  }
			      },
			      function(a, b){ // reverse order on b
				  if( a.b > b.b ){
				      return -1;
				  }else if( b.b > a.b ){
				      return 1;
				  }else{
				      return 0;
				  }
			      });
     mr_t.is_same_atom(4, or3.length, "hash ir1 test 7");
     mr_t.is_same_atom(9, or3[0].a, "hash ir1 test 8");
     mr_t.is_same_atom(2, or3[3].b, "hash ir1 test 9");
     
//      var or4 = bbop.core.pare(ir2,
// 			      function(item, i){ // remove a's % 3
// 				  if( item['a'] % 3 == 0 ){
// 				      return true;
// 				  }else{
// 				      return false;
// 				  }
// 			      },
// 			      function(a, b){ // reverse order
// 				  if( a['b'] > b['b'] ){
// 				      return -1;
// 				  }else if( b['b'] > a['b'] ){
// 				      return 1;
// 				  }else{
// 				      return 0;
// 				  }
// 			      });
//      mr_t.is_same_atom(3, or4.length, "ir2 test 1");
//      mr_t.is_same_atom(8, or4[0]['b'], "ir2 test 2");
//      mr_t.is_same_atom(2, or4[2]['b'], "ir2 test 3");
     
// })();

// get_keys.
(function(){

    var hash1 = {'foo': 3};
    var keys1 = bbop.core.get_keys(hash1);
    mr_t.is_same_atom(1, keys1.length, "got keys1 len");
    mr_t.is_same_atom('foo', keys1[0], "got keys1 str 0");

    var hash2 = {'foo': 3, 'bar': 4};
    var keys2 = bbop.core.get_keys(hash2);
    keys2.sort();
    mr_t.is_same_atom(2, keys2.length, "got keys2 len");
    mr_t.is_same_atom('bar', keys2[0], "got keys2 str 0");
    mr_t.is_same_atom('foo', keys2[1], "got keys2 str 1");
})();

// is_array.
(function(){
    var t1 = 1;
    var t2 = 'moo';
    var t3 = [];
    var t4 = {};
    var t5 = ['moo'];
    var t6 = {'cow': 'moo'};
    var t7 = function(){ return true; };

    mr_t.is_false(bbop.core.is_array(t1), "correctly is_array t1");
    mr_t.is_false(bbop.core.is_array(t2), "correctly is_array t2");
    mr_t.is_true(bbop.core.is_array(t3), "correctly is_array t3");
    mr_t.is_false(bbop.core.is_array(t4), "correctly is_array t4");
    mr_t.is_true(bbop.core.is_array(t5), "correctly is_array t5");
    mr_t.is_false(bbop.core.is_array(t6), "correctly is_array t6");
    mr_t.is_false(bbop.core.is_array(t7), "correctly is_array t7");
})();

// is_hash.
(function(){
    var t1 = 1;
    var t2 = 'moo';
    var t3 = [];
    var t4 = {};
    var t5 = ['moo'];
    var t6 = {'cow': 'moo'};
    var t7 = function(){ return true; };

    mr_t.is_false(bbop.core.is_hash(t1), "correctly is_hash t1");
    mr_t.is_false(bbop.core.is_hash(t2), "correctly is_hash t2");
    mr_t.is_false(bbop.core.is_hash(t3), "correctly is_hash t3");
    // ...?
    mr_t.is_true(bbop.core.is_hash(t4), "correctly is_hash t4");
    mr_t.is_false(bbop.core.is_hash(t5), "correctly is_hash t5");
    mr_t.is_true(bbop.core.is_hash(t6), "correctly is_hash t6");
    mr_t.is_false(bbop.core.is_hash(t7), "correctly is_hash t7");
})();

// is_same.
(function(){
     var t0 = null;
     var t1 = 1;
     var t2 = 'moo';
     var t3 = [];
     var t4 = {};
     var t5 = ['moo', 'a'];
     var t6 = {'cow': 'moo'};
     var t7 = true;
     var t8 = false;
     var t9 = {'a': true, 'b': false};

     // Simple and true things.
     mr_t.is_true(bbop.core.is_same(t0, null), "correctly is_same t0");
     mr_t.is_true(bbop.core.is_same(t1, 1), "correctly is_same t1");
     mr_t.is_true(bbop.core.is_same(t2, 'moo'), "correctly is_same t2");
     mr_t.is_true(bbop.core.is_same(t3, []), "correctly is_same t3");
     mr_t.is_true(bbop.core.is_same(t4, {}), "correctly is_same t4");
     mr_t.is_true(bbop.core.is_same(t5, ['moo', 'a']), "correctly is_same t5");
     mr_t.is_true(bbop.core.is_same(t6, {'cow': 'moo'}),
		  "correctly is_same t6");
     mr_t.is_true(bbop.core.is_same(t7, true), "correctly is_same t7");
     mr_t.is_true(bbop.core.is_same(t8, false), "correctly is_same t8");

     // Apparently, harder.
     mr_t.is_true(bbop.core.is_same(t9, {'a': true, 'b': false}),
		  "correctly is_same t9");

     // Now wrong things.
     mr_t.is_false(bbop.core.is_same(t0, 1), "not is_same t0");
     mr_t.is_false(bbop.core.is_same(t1, '1'), "not is_same t1a");
     mr_t.is_false(bbop.core.is_same(t1, 2), "not is_same t1b");
     mr_t.is_false(bbop.core.is_same(t2, 'mo'), "not is_same t2");
     mr_t.is_false(bbop.core.is_same(t3, null), "not is_same t3a");
     mr_t.is_false(bbop.core.is_same(t3, ['a']), "not is_same t3b");
     mr_t.is_false(bbop.core.is_same(t4, null), "not is_same t4a");
     mr_t.is_false(bbop.core.is_same(t4, {'a': 1}), "not is_same t4b");
     mr_t.is_false(bbop.core.is_same(t4, 1), "not is_same t4c");
     mr_t.is_false(bbop.core.is_same(t4, true), "not is_same t4d");
     mr_t.is_false(bbop.core.is_same(t5, []), "not is_same t5a");
     mr_t.is_false(bbop.core.is_same(t5, 1), "not is_same t5b");
     mr_t.is_false(bbop.core.is_same(t5, ['moo']), "not is_same t5d");
     mr_t.is_false(bbop.core.is_same(t5, ['moo', 'a', 'b']), "not is_same t5c");
     mr_t.is_false(bbop.core.is_same(t6, {}), "not is_same t6a");
     mr_t.is_false(bbop.core.is_same(t6, {'cw': 'moo'}), "not is_same t6b");
     mr_t.is_false(bbop.core.is_same(t6, {'cow': 'moo', 'dog': 'arf'}),
		   "not is_same t6c");
     mr_t.is_false(bbop.core.is_same(t7, false), "not is_same t7a");
     mr_t.is_false(bbop.core.is_same(t7, null), "not is_same t7b");
     mr_t.is_false(bbop.core.is_same(t8, true), "not is_same t8a");
     mr_t.is_false(bbop.core.is_same(t8, null), "not is_same t8b");

     // Again, apparently, harder.
     mr_t.is_false(bbop.core.is_same(t9, {'a': true}),
		   "not is_same t9a");
     mr_t.is_false(bbop.core.is_same(t9, {'a': false}),
		   "not is_same t9b");
     mr_t.is_false(bbop.core.is_same(t9, {'a': true, 'b': true}),
		   "not is_same t9c");
     mr_t.is_false(bbop.core.is_same(t9, {'a': false, 'b': true}),
		   "not is_same t9d");
     mr_t.is_false(bbop.core.is_same(t9, {'a': false, 'b': false}),
		   "not is_same t9e");
     mr_t.is_false(bbop.core.is_same(t9, {'a': true, 'b': false, 'c': true}),
		   "not is_same t9f");
     mr_t.is_false(bbop.core.is_same(t9, {'a': true, 'b': false, 'c': false}),
		   "not is_same t9g");

})();

// hashify.
(function(){

     var t0 = bbop.core.hashify();
     var t1 = bbop.core.hashify([]);
     var t2 = bbop.core.hashify(['a']);
     var t3 = bbop.core.hashify(['a', 'b', 'c']);
     var t4 = bbop.core.hashify([1, 2, 3]);

     mr_t.is_same_hash(t0, {}, "nil is same hashified");
     mr_t.is_same_hash(t1, {}, "[] is same hashified");
     mr_t.is_same_hash(t2, {'a': true}, "{a} is same hashified");
     mr_t.is_same_hash(t3, {'a': true, 'b': true, 'c': true},
		       "{a, b, c} is same hashified");
     mr_t.is_same_hash(t4, {1: true, 2: true, 3: true},
		       "{1, 2, ,3} is same hashified");     

})();

// is_empty.
(function(){
    var t1 = 1;
    var t2 = 'moo';
    var t3 = [];
    var t4 = {};
    var t5 = ['moo'];
    var t6 = {'cow': 'moo'};
    var t7 = function(){ return true; };

    mr_t.is_false(bbop.core.is_empty(t1), "correctly empty t1");
    mr_t.is_false(bbop.core.is_empty(t2), "correctly empty t2");
    mr_t.is_true(bbop.core.is_empty(t3), "correctly empty t3");
    mr_t.is_true(bbop.core.is_empty(t4), "correctly empty t4");
    mr_t.is_false(bbop.core.is_empty(t5), "correctly empty t5");
    mr_t.is_false(bbop.core.is_empty(t6), "correctly empty t6");
    mr_t.is_false(bbop.core.is_empty(t7), "correctly empty t7");
})();

// what_is.
(function(){
    // Simple items.
    mr_t.is_same_atom(bbop.core.what_is(), null, "nil");
    mr_t.is_same_atom(bbop.core.what_is(null), "null", "null");
    mr_t.is_same_atom(bbop.core.what_is(true), "boolean", "boolean");
    mr_t.is_same_atom(bbop.core.what_is(''), "string", "string 1");
    mr_t.is_same_atom(bbop.core.what_is('hi'), "string", "string 2");
    mr_t.is_same_atom(bbop.core.what_is(0), "number", "number 1");
    mr_t.is_same_atom(bbop.core.what_is(-1), "number", "number 2");
    mr_t.is_same_atom(bbop.core.what_is(1), "number", "number 3");
    mr_t.is_same_atom(bbop.core.what_is([]), "array", "array 1");
    mr_t.is_same_atom(bbop.core.what_is([1, 2]), "array", "array 2");
    mr_t.is_same_atom(bbop.core.what_is({}), "object", "object 1");
    mr_t.is_same_atom(bbop.core.what_is({a: 2, 'b': 3}), "object", "object 2");
    mr_t.is_same_atom(bbop.core.what_is(function(x){ return x; }),
		      "function", "function");

    // More complicated items.
    foo = {};
    foo.bar = function(){
	this._is_a = 'foo.bar';
    };
    var fb = new foo.bar();
    mr_t.is_same_atom(bbop.core.what_is(fb), 'foo.bar', 'class/object');
})();

// to_string.
(function(){
    
    function foo (){
	this.to_string = function(){
	    return 'foo!';
	};
    }

    var f = new foo();

    mr_t.is_same_atom(bbop.core.to_string(0), '0', "to_string 0");
    mr_t.is_same_atom(bbop.core.to_string('a'), 'a', "to_string 1");
    mr_t.is_same_atom(bbop.core.to_string(f), 'foo!', "to_string 2");
})();

// dump.
(function(){
    mr_t.is_same_atom(bbop.core.dump(), 'null', "dump 0");
    mr_t.is_same_atom(bbop.core.dump(''), '""', "dump 1");
    mr_t.is_same_atom(bbop.core.dump('abc'), '"abc"', "dump 2");
    mr_t.is_same_atom(bbop.core.dump(1), "1", "dump 3");
    mr_t.is_same_atom(bbop.core.dump(null), "null", "dump 4");
    mr_t.is_same_atom(bbop.core.dump(true), "true", "dump 5");
    mr_t.is_same_atom(bbop.core.dump([]), "[]", "dump 6");
    mr_t.is_same_atom(bbop.core.dump({}), "{}", "dump 7");
    mr_t.is_same_atom(bbop.core.dump([null, ['bob', 'bar', {foo: 1}]]),
		      '[null, ["bob", "bar", {"foo": 1}]]', "dump 8");
})();

// Check hash folding.
(function(){
     var a_hash = {foo: 1, bar: 2};
     mr_t.is_same_hash({}, bbop.core.fold({},{}), 'empty fold');
     mr_t.is_same_hash(a_hash, bbop.core.fold({foo:1, bar:2},{}),'same fold');
     mr_t.is_same_hash(a_hash, bbop.core.fold({foo:1, bar:3},{bar:2}),
		       'distinct fold');
     mr_t.is_different_hash(a_hash, bbop.core.fold({foo:1},{bar:2}),
			    'bar fold');
 })();

// Check hash merging.
(function(){
     var a_hash = {foo: 1, bar: 2};
     mr_t.is_same_hash({}, bbop.core.merge({},{}), 'empty merge');
     mr_t.is_same_hash(a_hash, bbop.core.merge({foo:1, bar:3},{bar:2}),
			    'distinct merge');
     mr_t.is_same_hash(a_hash, bbop.core.merge({foo:1, bar:2}, {}),
		       'bar merge 1');
     mr_t.is_same_hash(a_hash, bbop.core.merge({foo:1},{bar:2}),
		       'bar merge 2');
     mr_t.is_same_hash(a_hash, bbop.core.merge({}, {foo:1, bar:2}),
		       'bar merge 3');
 })();

// Check cloning.
(function(){

    var foo = {a: 1, b: true, c:[1,2,[3]], d:{one: 'a', two: ['b']}};
    var bar = bbop.core.clone(foo);

    // Change the original.
    foo.a = 2;
    foo.b = false;
    foo.c[2][0] = 4;
    foo.d.two[0] = 'c';

    // Check the similarities.
    mr_t.is_same_atom(foo.c.length, bar.c.length, 'array length preserved');
    mr_t.is_same_atom(foo.c[0], bar.c[0], 'array 0 preserved');
    mr_t.is_same_atom(foo.d.one, bar.d.one, 'hash prop preserved');    

    // Check differences.
    mr_t.is_different_atom(foo.a, bar.a, 'different int');
    mr_t.is_different_atom(foo.b, bar.b, 'different bool');
    mr_t.is_different_atom(foo.c[2][0], bar.c[2][0], 'different double index');
    mr_t.is_different_atom(foo.d.two[0], bar.d.two[0], 'different in hash');
})();

// Check encoding ids.
(function(){

    var rounds = ["GO:1234567", "GO::GO:1234567", "::1:2::3:"];
    var coders = [new bbop.core.coder(),
		  new bbop.core.coder({string: "_TEST_", size: 1})];

    // Iterate through coders and strings.
    for( var cdr = 0; cdr < coders.length; cdr++ ){
	var coder = coders[cdr];
	for( var rnd = 0; rnd < rounds.length; rnd++ ){
	    var round = rounds[rnd];

	    //
	    var enc = coder.encode(round);
	    //print(enc);
	    mr_t.is_same_atom(round, coder.decode(enc),
			      "round trip (coder: " +
			      cdr + ', string: "' +
			      round + '")');
	}
    }
})();

///
/// End unit testing.
///

// Final report.
mr_t.report();
